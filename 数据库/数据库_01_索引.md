# 数据库索引全面解析

## 索引是什么？

数据库中查找操作非常普遍，索引就是提升查找速度的一种手段。

## 索引分类

1. B+树索引 
    它就是传统意义上的索引，它是最常用、最有效的索引。
2. 哈希索引 
    哈希索引是一种自适应的索引，数据库会根据表的使用情况自动生成哈希索引，我们人为是没办法干预的。
3. 全文索引 
    用于实现关键词搜索。但它只能根据空格分词，因此不支持中文。 
    若要实现搜索功能，可选择lucene。
4. RTree索引 
    在mysql很少使用，仅支持geometry数据类型；相对于BTREE，RTREE的优势在于范围查找。

## B+树索引

数据库以页为存储单元，一个页是8K（8192Byte），一页可以存放N条记录。 
 页在B+树中分为：数据页和索引页。 
 B+树的高一般为2-4层，因此查找某一键值的行记录只需2-4次IO，效率较高。

### 聚集索引 和 非聚集索引

不管是聚集索引还是非聚集索引，它们的逻辑结构都一棵是B+树，它们的唯一区别在于：

- 聚集索引的数据页存放的是完整的记录；也就是说，聚集索引决定了表的物理存储顺序；
- 非聚集索引的数据页只存指向记录的地址信息，它真正的数据已经在聚集索引中存储了。

### 联合索引 和 覆盖索引

1. 联合索引 
    当查询条件涉及多列时，可以使用联合索引。
2. 覆盖索引 
    只需通过辅助索引就能获取要查询的信息，而无需再次通过聚集索引查询具体的记录信息。 
    由于覆盖索引并不包含整行的记录，因此它的大小远远小于聚集索引。 
    它比较适合做一些统计操作。

### MyISAM索引实现

1. 主键索引 
    在主键索引中，索引页中存放的是主键和指向数据页的偏移量；数据页中存放的是主键和该主键所属行记录的地址空间。
2. 辅助索引 
    在MyISAM中，主索引和辅助索引（Secondary key）在结构上没有任何区别，只是主索引要求key是唯一的，而辅助索引的key可以重复。

综上所述，在MyISAM中，索引文件和数据文件分开存放，不管是主键索引还是辅助索引，都属于非聚集索引。

### InnoDB索引实现

1. 主键索引 
    索引页仍然存放主键和和指向数据页的偏移量，但数据页存放的是完整的记录。 
    也就是在InnoDB中，数据和主键索引是存放在一起的。
2. 辅助索引 
    索引节点存放的内容一样，仍然是键值信息和指向数据页的偏移量；但数据页中存放的是键值信息和该键值对应的主键。然后通过主键查询主键索引就能找到该条记录。

综上所述：

- 聚集索引这种实现方式使得按主键的搜索十分高效，但是辅助索引搜索需要检索两遍索引：首先检索辅助索引获得主键，然后用主键到主索引中检索获得记录。
- InnoDB的辅助索引也会包含主键列，所以，如果主键定义的比较大，其他索引也将很大。如果想在表上定义 、很多索引，则争取尽量把主键定义得小一些。InnoDB 不会压缩索引。

## 索引的优点

- 第一，通过创建唯一性索引，可以保证数据库表中每一行数据的唯一性。
- 第二，可以大大加快数据的检索速度，这也是创建索引的最主要的原因。
- 第三，可以加速表和表之间的连接，特别是在实现数据的参考完整性方面特别有意义。
- 第四，在使用分组和排序子句进行数据检索时，同样可以显著减少查询中分组和排序的时间。
- 第五，通过使用索引，可以在查询的过程中，使用优化隐藏器，提高系统的性能。 

## 索引的缺点

- 第一，创建索引和维护索引要耗费时间，这种时间随着数据量的增加而增加。
- 第二，索引需要占物理空间，除了数据表占数据空间之外，每一个索引还要占一定的物理空间，如果要建立聚簇索引，那么需要的空间就会更大。
- 第三，当对表中的数据进行增加、删除和修改的时候，索引也要动态的维护，这样就降低了数据的维护速度。

## 哪些情况需要加索引？

- 在经常需要搜索的列上，可以加快搜索的速度；
- 在作为主键的列上，强制该列的唯一性和组织表中数据的排列结构；
- 在经常用在连接的列上，这些列主要是一些外键，可以加快连接的速度；
- 在经常需要根据范围进行搜索的列上创建索引，因为索引已经排序，其指定的范围是连续的；
- 在经常需要排序的列上创建索引，因为索引已经排序，这样查询可以利用索引的排序，加快排序查询时间；
- 在经常使用在WHERE子句中的列上面创建索引，加快条件的判断速度。

## 哪些情况不需要加索引？

- 第一，对于那些在查询中很少使用或者参考的列不应该创建索引。这是因为，既然这些列很少使用到，因此有索引或者无索引，并不能提高查询速度。相反，由于增加了索引，反而降低了系统的维护速度和增大了空间需求。
- 第二，对于那些只有很少数据值的列也不应该增加索引。这是因为，由于这些列的取值很少，例如人事表的性别列，在查询的结果中，结果集的数据行占了表中数据行的很大比例，即需要在表中搜索的数据行的比例很大。增加索引，并不能明显加快检索速度。
- 第三，对于那些定义为text, image和bit数据类型的列不应该增加索引。这是因为，这些列的数据量要么相当大，要么取值很少。 
   第四，当修改性能远远大于检索性能时，不应该创建索引。这是因为，修改性能和检索性能是互相矛盾的。当增加索引时，会提高检索性能，但是会降低修改性能。当减少索引时，会提高修改性能，降低检索性能。因此，当修改性能远远大于检索性能时，不应该创建索引。